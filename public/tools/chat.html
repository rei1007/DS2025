<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配信メンバーチャット</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Zen+Kaku+Gothic+New:wght@500;700;900&display=swap"
        rel="stylesheet">

    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />

    <style>
        /* --- テーマ定義 (共通) --- */
        :root {
            --color-main: #1F2937;
            --color-bg: #F3F4F6;
            --color-panel: #FFFFFF;
            --color-shadow: #D1D5DB;

            --color-staff-bg-other: #EFF6FF;
            --color-staff-border-other: #2563EB;
            --color-staff-bg-me: #1E40AF;
        }

        body {
            font-family: 'Zen Kaku Gothic New', 'Kosugi Maru', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-main);
            overflow: hidden;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48;
            font-size: 24px;
        }

        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        /* --- メッセージバブル --- */
        .msg-bubble {
            background-color: var(--color-panel);
            border: 2px solid var(--color-main);
            border-radius: 0.75rem;
            padding: 1.25rem;
            max-width: 90%;
            position: relative;
            box-shadow: 4px 4px 0 0 var(--color-shadow);
            transition: transform 0.2s;
        }

        .msg-me {
            background-color: var(--color-main);
            color: #FFFFFF;
            margin-left: auto;
            border-color: var(--color-main);
        }

        .msg-me .msg-text {
            color: #FFFFFF;
        }

        .msg-me .msg-name {
            color: #D1D5DB;
        }

        .msg-me .role-badge {
            background-color: #FFFFFF;
            color: var(--color-main);
            border-color: #FFFFFF;
        }

        .msg-other {
            background-color: #FFFFFF;
            color: var(--color-main);
            margin-right: auto;
        }

        .msg-other .role-badge {
            background-color: var(--color-main);
            color: #FFFFFF;
        }

        .msg-staff-other {
            background-color: var(--color-staff-bg-other);
            border-color: var(--color-staff-border-other);
            color: #1E3A8A;
        }

        .msg-staff-other .role-badge {
            background-color: var(--color-staff-border-other);
            color: white;
            border-color: var(--color-staff-border-other);
        }

        .msg-staff-me {
            background-color: var(--color-staff-bg-me);
            border-color: var(--color-staff-bg-me);
            color: #FFFFFF;
        }

        .msg-staff-me .msg-text {
            color: #FFFFFF !important;
        }

        .msg-staff-me .msg-name {
            color: #BFDBFE !important;
        }

        .msg-staff-me .role-badge {
            background-color: #FFFFFF;
            color: var(--color-staff-bg-me);
            border-color: #FFFFFF;
        }

        .role-badge {
            font-size: 0.7rem;
            font-weight: 900;
            padding: 0.15rem 0.6rem;
            border: 2px solid var(--color-main);
            border-radius: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
        }

        .msg-text {
            font-size: 1.125rem;
            line-height: 1.75;
            font-weight: 500;
        }

        /* --- チャット内画像 --- */
        .msg-image-container {
            margin-top: 0.5rem;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .msg-image {
            display: block;
            max-width: 100%;
            max-height: 300px;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .msg-image:hover {
            opacity: 0.9;
        }

        /* --- 入力エリア --- */
        .input-area {
            background-color: var(--color-panel);
            border-top: 2px solid var(--color-main);
            padding: 1rem;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        textarea {
            border: 2px solid var(--color-main);
            border-radius: 0.75rem;
            background-color: #F9FAFB;
            font-family: inherit;
            color: var(--color-main);
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.2s;
        }

        textarea:focus {
            outline: none;
            background-color: #FFFFFF;
            box-shadow: 4px 4px 0 0 var(--color-shadow);
            transform: translate(-2px, -2px);
        }

        #send-button {
            background-color: var(--color-main);
            color: #FFFFFF;
            border: 2px solid var(--color-main);
            border-radius: 0.75rem;
            transition: all 0.2s;
            box-shadow: 2px 2px 0 0 var(--color-shadow);
        }

        #send-button:hover {
            background-color: #FFFFFF;
            color: var(--color-main);
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 0 var(--color-shadow);
        }

        #send-button:active {
            transform: translate(0, 0);
            box-shadow: none;
        }

        #send-button:disabled {
            background-color: #E5E7EB;
            border-color: #D1D5DB;
            color: #9CA3AF;
            cursor: not-allowed;
            box-shadow: none;
        }

        #select-image-btn {
            transition: all 0.2s;
        }

        #select-image-btn:hover {
            background-color: #F3F4F6;
        }

        .delete-btn {
            position: absolute;
            top: -12px;
            left: -12px;
            background-color: #EF4444;
            color: white;
            border: 2px solid var(--color-main);
            border-radius: 0.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
            box-shadow: 2px 2px 0 0 rgba(0, 0, 0, 0.1);
        }

        .msg-bubble:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background-color: #DC2626;
            transform: scale(1.1);
        }

        /* --- モーダル --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            background: #FFFFFF;
            width: 90%;
            max-width: 400px;
            border: 2px solid var(--color-main);
            border-radius: 1rem;
            box-shadow: 8px 8px 0 0 var(--color-main);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transform: scale(0.95);
            transition: transform 0.2s;
        }

        .modal-overlay.show .modal-box {
            transform: scale(1);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--color-main);
        }

        .modal-msg {
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.6;
            color: #374151;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn-modal {
            padding: 0.5rem 1.5rem;
            font-weight: 700;
            border: 2px solid var(--color-main);
            border-radius: 0.5rem;
            transition: all 0.1s;
            box-shadow: 2px 2px 0 0 var(--color-shadow);
        }

        .btn-modal:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .btn-cancel {
            background: white;
            color: var(--color-main);
        }

        .btn-cancel:hover {
            background: #F3F4F6;
        }

        .btn-ok {
            background: var(--color-main);
            color: white;
        }

        .btn-ok:hover {
            background: #374151;
        }

        .btn-danger {
            background: #EF4444;
            color: white;
            border-color: var(--color-main);
        }

        .btn-danger:hover {
            background: #DC2626;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900">

    <div class="max-w-[1080px] mx-auto flex flex-col h-screen border-x-0 md:border-x-2 md:border-gray-200">

        <main id="chat-messages" class="flex-1 overflow-y-auto p-4 md:p-6 flex flex-col-reverse gap-6">
        </main>

        <footer class="input-area">
            <div id="image-preview-area"
                class="hidden mb-3 p-2 bg-white border-2 border-gray-800 rounded-lg flex items-center justify-between shadow-sm">
                <div class="flex items-center gap-3 overflow-hidden">
                    <img id="image-preview" src="" alt="preview"
                        class="h-12 w-12 object-cover rounded border border-gray-300">
                    <span id="image-name"
                        class="text-xs font-bold text-gray-500 truncate max-w-[150px]">filename.jpg</span>
                </div>
                <button id="clear-image-btn" class="p-1 hover:bg-red-100 rounded-full text-red-500 transition-colors">
                    <span class="material-symbols-rounded text-xl">close</span>
                </button>
            </div>

            <div class="flex items-end gap-3">
                <button id="select-image-btn"
                    class="flex items-center justify-center w-[60px] h-[60px] flex-shrink-0 bg-white border-2 border-gray-800 rounded-xl shadow-[2px_2px_0_0_rgba(0,0,0,0.2)] hover:shadow-[4px_4px_0_0_rgba(0,0,0,0.2)] hover:-translate-y-0.5 transition-all active:translate-y-0 active:shadow-none text-gray-700"
                    title="画像を追加">
                    <span class="material-symbols-rounded !text-3xl">add_photo_alternate</span>
                </button>
                <input type="file" id="image-input" accept="image/*" class="hidden">

                <textarea id="chat-input" rows="1" placeholder="メッセージを入力"
                    class="flex-1 p-4 resize-none min-h-[60px] max-h-[150px] leading-relaxed placeholder-gray-400"></textarea>

                <button id="send-button" class="flex items-center justify-center w-[60px] h-[60px] flex-shrink-0">
                    <span class="material-symbols-rounded !text-3xl" style="margin-left: 2px;">send</span>
                </button>
            </div>
        </footer>
    </div>

    <div id="alert-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title" id="alert-title"></h3>
            <p class="modal-msg" id="alert-msg"></p>
            <div class="modal-actions"><button class="btn-modal btn-ok" onclick="closeAlert()">OK</button></div>
        </div>
    </div>
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title" id="confirm-title"></h3>
            <p class="modal-msg" id="confirm-msg"></p>
            <div class="modal-actions"><button class="btn-modal btn-cancel"
                    onclick="closeConfirm(false)">CANCEL</button><button class="btn-modal btn-danger"
                    id="confirm-ok-btn">EXECUTE</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, writeBatch, doc, query, orderBy, onSnapshot, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        // Storageのimportは不要なので削除しました

        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.firebasestorage.app",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const messagesRef = collection(db, "messages");

        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const chatMessages = document.getElementById('chat-messages');
        const imageInput = document.getElementById('image-input');
        const selectImageBtn = document.getElementById('select-image-btn');
        const imagePreviewArea = document.getElementById('image-preview-area');
        const imagePreview = document.getElementById('image-preview');
        const imageName = document.getElementById('image-name');
        const clearImageBtn = document.getElementById('clear-image-btn');

        let selectedImageBase64 = null; // Base64データを保持
        let currentUser = { name: '', role: '', uid: '' };

        // --- モーダル制御 ---
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMsg = document.getElementById('alert-msg');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMsg = document.getElementById('confirm-msg');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        let confirmCallback = null;

        window.showAlert = (title, msg) => {
            alertTitle.innerHTML = `<span class="material-symbols-rounded text-yellow-500">info</span> ${title}`;
            alertMsg.textContent = msg;
            alertModal.classList.add('show');
        };
        window.closeAlert = () => alertModal.classList.remove('show');
        window.showConfirm = (title, msg, callback) => {
            confirmTitle.innerHTML = `<span class="material-symbols-rounded text-red-500">warning</span> ${title}`;
            confirmMsg.textContent = msg;
            confirmCallback = callback;
            confirmModal.classList.add('show');
        };
        window.closeConfirm = (isOk) => {
            confirmModal.classList.remove('show');
            if (isOk && confirmCallback) confirmCallback();
            confirmCallback = null;
        };
        confirmOkBtn.onclick = () => closeConfirm(true);

        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'settings-update') {
                currentUser = event.data.user;
            }
        });

        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = (chatInput.scrollHeight) + 'px';
        });

        // --- 画像選択・圧縮処理 ---
        selectImageBtn.addEventListener('click', () => imageInput.click());

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processImage(file);
            }
        });

        function processImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // Canvasでリサイズして圧縮
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // 最大サイズ設定 (Firestore制限対策のため小さめに)
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // JPEG形式, 画質0.7で圧縮してBase64化
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                    // データサイズチェック (約900KB超えたら警告してクリア)
                    if (dataUrl.length > 900 * 1024) {
                        showAlert("SIZE ERROR", "画像サイズが大きすぎます。別の画像を選択してください。");
                        clearImageSelection();
                        return;
                    }

                    selectedImageBase64 = dataUrl;
                    imagePreview.src = dataUrl;
                    imageName.textContent = file.name;
                    imagePreviewArea.classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearImageSelection() {
            selectedImageBase64 = null;
            imageInput.value = '';
            imagePreviewArea.classList.add('hidden');
        }

        clearImageBtn.addEventListener('click', clearImageSelection);


        // --- 送信処理 ---
        async function sendMessage() {
            let messageText = chatInput.value.trim();

            if (!messageText && !selectedImageBase64) return;

            if (!currentUser.name) {
                showAlert("USER SETTING ERROR", "ユーザー設定が読み込まれていません。親画面をリロードしてください。");
                return;
            }

            const isStaff = (currentUser.role === "運営" || currentUser.role === "配信担当");

            // コマンド処理
            if (messageText === "/allclear") {
                if (isStaff) {
                    showConfirm("CLEAR ALL HISTORY", "【警告】すべてのチャット履歴を削除します。", async () => {
                        await clearAllMessages();
                        chatInput.value = '';
                        chatInput.style.height = 'auto';
                    });
                    return;
                }
            }

            let isStaffOnly = false;
            if (messageText.startsWith("/staff ")) {
                if (isStaff) {
                    isStaffOnly = true;
                    messageText = messageText.replace("/staff ", "");
                } else {
                    showAlert("PERMISSION DENIED", "スタッフ限定チャットは使用できません。");
                    return;
                }
            }

            sendButton.disabled = true;

            try {
                // Storageを使わず、Base64文字列をそのまま保存
                await addDoc(messagesRef, {
                    text: messageText,
                    imageUrl: selectedImageBase64, // ここにBase64が入る
                    name: currentUser.name,
                    role: currentUser.role,
                    uid: currentUser.uid,
                    timestamp: Date.now(),
                    isStaffOnly: isStaffOnly
                });

                // リセット
                chatInput.value = '';
                chatInput.style.height = 'auto';
                clearImageSelection();
                chatMessages.scrollTop = 0;

            } catch (error) {
                console.error("Error sending message: ", error);
                if (error.code === 'resource-exhausted') {
                    showAlert("ERROR", "データサイズが大きすぎて送信できませんでした。");
                } else {
                    showAlert("ERROR", "送信に失敗しました。");
                }
            } finally {
                sendButton.disabled = false;
            }
        }

        async function clearAllMessages() {
            try {
                const q = query(messagesRef);
                const snapshot = await getDocs(q);
                if (snapshot.empty) return;
                const batch = writeBatch(db);
                snapshot.docs.forEach((doc) => { batch.delete(doc.ref); });
                await batch.commit();
            } catch (error) {
                showAlert("ERROR", "全削除に失敗しました。");
            }
        }

        function deleteMessage(messageId) {
            showConfirm("DELETE MESSAGE", "このメッセージを削除しますか？", async () => {
                try { await deleteDoc(doc(db, "messages", messageId)); }
                catch (error) { console.error("削除エラー:", error); }
            });
        }

        sendButton.addEventListener('click', sendMessage);

        // Shift+Enterで送信、Enterのみは改行
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            }
        });

        const q = query(messagesRef, orderBy("timestamp", "desc"), limit(50)); // 読み込み数を少し減らす

        onSnapshot(q, (snapshot) => {
            chatMessages.innerHTML = '';
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const messageId = docSnap.id;
                const isMe = data.uid === currentUser.uid;
                const isStaffMsg = data.isStaffOnly;
                const amIStaff = (currentUser.role === "運営" || currentUser.role === "配信担当");

                if (!isStaffMsg || (isStaffMsg && amIStaff)) {
                    const messageElement = createMessageHTML(messageId, data.name, data.role, data.text, data.imageUrl, isMe, isStaffMsg);
                    chatMessages.appendChild(messageElement);
                }
            });
        });

        // URLをリンク化する関数（XSS対策込み）
        function makeLinksClickable(text, linkColorClass) {
            // 1. まずHTML特殊文字をエスケープして、スクリプト埋め込みを防ぐ
            const escapedText = text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");

            // 2. URLの正規表現 (httpまたはhttpsで始まるもの)
            const urlRegex = /(https?:\/\/[^\s]+)/g;

            // 3. <a>タグに置換
            // break-all: 長いURLでも枠をはみ出さないようにする
            // target="_blank": 別タブで開く
            return escapedText.replace(urlRegex, function (url) {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="${linkColorClass} underline break-all hover:opacity-70">${url}</a>`;
            });
        }

        function createMessageHTML(id, name, role, text, imageUrl, isMe, isStaffMsg) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            let bubbleClass = 'msg-bubble';
            if (isMe) bubbleClass += isStaffMsg ? ' msg-staff-me' : ' msg-me';
            else bubbleClass += isStaffMsg ? ' msg-staff-other' : ' msg-other';
            bubble.className = bubbleClass;

            const header = document.createElement('div');
            header.className = 'flex items-baseline gap-2 mb-2';
            const nameSpan = document.createElement('span');
            nameSpan.className = 'font-bold text-sm msg-name uppercase tracking-wider';
            nameSpan.textContent = name;
            const roleSpan = document.createElement('span');
            roleSpan.className = 'role-badge';
            roleSpan.textContent = role;
            header.appendChild(nameSpan);
            header.appendChild(roleSpan);

            if (isMe) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '<span class="material-symbols-rounded" style="font-size: 20px;">close</span>';
                deleteBtn.onclick = () => deleteMessage(id);
                bubble.appendChild(deleteBtn);
            }
            bubble.appendChild(header);

            if (imageUrl) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'msg-image-container';
                const img = document.createElement('img');
                img.src = imageUrl; // Base64文字列がそのままsrcになる
                img.className = 'msg-image';
                // Base64画像を別タブで開くための処理
                img.onclick = () => {
                    const w = window.open('about:blank');
                    const image = new Image();
                    image.src = imageUrl;
                    setTimeout(() => w.document.write(image.outerHTML), 0);
                };
                imgContainer.appendChild(img);
                bubble.appendChild(imgContainer);
            }

            // --- 修正箇所ここから ---
            if (text) {
                const textP = document.createElement('p');
                textP.className = 'msg-text whitespace-pre-wrap leading-relaxed';
                if (imageUrl) textP.style.marginTop = '0.5rem';

                // 変更前: textP.textContent = text;

                // 変更後: 背景色に合わせてリンクの色を変えつつ、HTMLとして挿入
                // isMe（自分）の場合は背景が濃いので水色(cyan-300)、相手の場合は青色(blue-600)
                const linkColor = isMe ? 'text-cyan-300' : 'text-blue-600';

                textP.innerHTML = makeLinksClickable(text, linkColor);

                bubble.appendChild(textP);
            }
            // --- 修正箇所ここまで ---

            wrapper.appendChild(bubble);
            return wrapper;
        }
    </script>
</body>

</html>