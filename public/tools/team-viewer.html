<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>チーム情報閲覧</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Zen+Kaku+Gothic+New:wght@500;700;900&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />

    <style>
        /* --- デザイン定義 (Soft Brutalism) --- */
        :root {
            --color-main: #374151;    /* 少しグレー寄りの黒 (#1F2937 -> #374151) */
            --color-bg: #F9FAFB;      /* より明るい背景 */
            --color-panel: #FFFFFF;
            --color-shadow: #D1D5DB;  /* 薄めの影色 */

            --color-alpha: #d0be08;   /* Alpha: 黄 (少し落ち着いた色味) */
            --color-bravo: #3a0ccd;   /* Bravo: 青 (少し落ち着いた色味) */
            
            --color-alpha-light: #FEFCE8;
            --color-bravo-light: #EFF6FF;
        }

        body {
            font-family: 'Zen Kaku Gothic New', 'Kosugi Maru', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-main);
            overflow-y: auto;
            /* ドットパターンを非常に薄く */
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* カスタムスクロールバー (細く、控えめに) */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: #9CA3AF;
            border-radius: 3px;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 48;
            font-size: 24px;
        }

        /* --- コンポーネント --- */

        /* 共通ボックス (線を細く、影を小さく) */
        .brutal-box {
            background-color: var(--color-panel);
            border: 2px solid var(--color-main); /* 3px -> 2px */
            box-shadow: 4px 4px 0 0 var(--color-shadow); /* 6px -> 4px */
            border-radius: 0.75rem;
            transition: all 0.2s;
        }

        /* メインカード */
        .team-card {
            height: fit-content;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            border: 2px solid var(--color-main);
            box-shadow: 6px 6px 0 0 var(--color-shadow); /* 10px -> 6px */
            position: relative;
            margin-bottom: 2rem;
            background-color: white;
        }

        .team-card-header-bar {
            height: 12px;
            width: 100%;
            border-bottom: 2px solid var(--color-main);
            border-radius: 0.8rem 0.8rem 0 0;
        }
        .bar-alpha { background-color: var(--color-alpha); }
        .bar-bravo { background-color: var(--color-bravo); }

        .team-card-body {
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        /* ヘッダー周り */
        .header-section {
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #E5E7EB; /* 点線やグレー線に変更して柔らかく */
            padding-bottom: 1.5rem;
        }

        .univ-name {
            font-size: 1.8rem;
            font-weight: 800;
            color: #4B5563; /* 真っ黒ではなく濃いグレー */
            line-height: 1.2;
            margin-bottom: 0.25rem;
            letter-spacing: 0.05em;
        }

        .team-kana {
            font-size: 1.1rem;
            font-weight: 700;
            color: #6B7280;
            margin-bottom: 0;
            line-height: 1.2;
        }

        .team-name {
            font-size: 2.5rem;
            font-weight: 900;
            line-height: 1.1;
            color: var(--color-main);
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
        }

        /* 平均XP: 塗りつぶしではなく、枠線スタイルまたは角丸強めで柔らかく */
        .avg-xp-box {
            display: inline-block;
            background-color: white;
            color: var(--color-main);
            font-weight: 800;
            font-size: 1rem;
            padding: 0.25rem 1rem;
            border-radius: 9999px; /* 丸く */
            box-shadow: 2px 2px 0 0 var(--color-shadow);
            margin-top: 0.5rem;
            border: 2px solid var(--color-main);
            transform: none; /* 回転をなくして落ち着かせる */
        }
        
        /* サークルタグ */
        .circle-tag {
            display: inline-flex;
            align-items: center;
            background-color: #F9FAFB;
            border: 2px solid var(--color-main); /* 3px -> 2px */
            border-radius: 0.75rem;
            padding: 0.4rem 1rem 0.4rem 0.5rem;
            cursor: pointer;
            box-shadow: 2px 2px 0 0 var(--color-shadow);
            transition: transform 0.1s;
            margin-right: 0.5rem;
        }
        .circle-tag:hover { transform: translateY(-1px); box-shadow: 3px 3px 0 0 var(--color-shadow); }
        .circle-icon { font-size: 24px; margin-right: 0.5rem; color: #6B7280; }

        /* メンバーリスト */
        .member-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .member-card {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: white;
            border: 2px solid #E5E7EB; /* 薄いグレーの枠線 */
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* ソフトシャドウ */
            transition: transform 0.1s;
        }

        /* 最高XP選手: ボーダー色変更 (太さは控えめに) */
        .member-card.highest-xp-alpha {
            border: 2px solid var(--color-alpha);
            background-color: var(--color-alpha-light);
            box-shadow: 0 2px 0 0 var(--color-alpha);
        }
        .member-card.highest-xp-bravo {
            border: 2px solid var(--color-bravo);
            background-color: var(--color-bravo-light);
            box-shadow: 0 2px 0 0 var(--color-bravo);
        }

        .xp-box {
            background-color: #F3F4F6;
            color: #4B5563;
            font-family: 'Kosugi Maru';
            font-weight: 800;
            padding: 0.2rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            margin-right: 1rem;
            min-width: 64px;
            text-align: center;
            border: 1px solid #D1D5DB;
        }

        .highest-xp-alpha .xp-box {
            background-color: white; color: #854D0E; border-color: var(--color-alpha); font-weight: 900;
        }
        .highest-xp-bravo .xp-box {
            background-color: white; color: #1E40AF; border-color: var(--color-bravo); font-weight: 900;
        }

        .name-group {
            flex: 1;
            display: flex;
            align-items: baseline;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .member-name {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--color-main);
            line-height: 1;
        }

        .member-kana {
            font-size: 0.75rem;
            font-weight: 600;
            color: #9CA3AF;
        }

        .member-weapon {
            display: block;
            width: 100%;
            font-size: 0.85rem;
            font-weight: 600;
            color: #6B7280;
            margin-top: 0.25rem;
        }

        /* 配信紹介禁止の注釈 */
        .xp-warning-text {
            text-align: right;
            font-size: 0.7rem;
            font-weight: 600;
            color: #9CA3AF;
            margin-top: 0.25rem;
            margin-bottom: 2rem;
            display: block;
        }

        /* 情報セクション */
        .info-separator {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .info-separator-line {
            flex: 1;
            height: 2px;
            background-color: #E5E7EB;
        }
        .info-separator-text {
            font-weight: 800;
            font-size: 1rem;
            color: #9CA3AF;
            background-color: #F3F4F6;
            padding: 0.25rem 1rem;
            border-radius: 9999px;
            letter-spacing: 0.1em;
        }

        .info-block {
            background-color: white;
            border: 2px solid #E5E7EB;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .info-label {
            position: absolute;
            top: -12px;
            left: 1rem;
            background-color: #F3F4F6;
            color: #4B5563;
            font-weight: 700;
            font-size: 0.8rem;
            padding: 0.1rem 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid #E5E7EB;
        }

        .info-content {
            font-weight: 500;
            line-height: 1.7;
            white-space: pre-wrap;
            color: #4B5563;
        }

        .info-block.tactics {
            border-color: #FECACA;
            background-color: #FEF2F2;
        }
        .info-block.tactics .info-label { 
            background-color: #FEE2E2; color: #B91C1C; border-color: #FECACA;
        }
        .info-block.tactics .info-content { color: #B91C1C; font-weight: 700; }

        /* フッター類 */
        #sync-match-btn {
            position: fixed;
            bottom: 6rem; left: 50%; transform: translateX(-50%); z-index: 40;
            /* width/heightをautoにして可変に、paddingを追加 */
            width: auto; height: 3.5rem; padding: 0 1.5rem;
            background-color: var(--color-main); color: white;
            border: 2px solid white;
            border-radius: 9999px; /* 丸み */
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            opacity: 0; pointer-events: none; transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            font-weight: 800;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        #sync-match-btn.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
        #sync-match-btn:hover { background-color: #111827; }

        /* アニメーション用 */
        @keyframes pulse-subtle {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }
        #sync-match-btn.show { animation: pulse-subtle 2s infinite; }


        .footer-select-area {
            position: sticky; bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-top: 1px solid #E5E7EB;
            padding: 1rem;
            z-index: 30;
        }
        .team-select {
            width: 100%; padding: 0.6rem 1rem;
            background-color: white;
            border: 2px solid #D1D5DB;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 0.95rem;
            color: #374151;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* モーダル */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(31, 41, 55, 0.5); /* 半透明を薄く */
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; width: 90%; max-width: 600px; max-height: 90vh;
            border: 2px solid var(--color-main);
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); /* ソフトなドロップシャドウ */
            overflow: hidden; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.2s;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        
        /* モバイルタブ */
        .mobile-tab-btn {
            border: 1px solid #D1D5DB;
            background-color: white;
            color: #6B7280;
            border-radius: 0.5rem;
            padding: 0.5rem; font-weight: 700;
            transition: all 0.2s;
        }
        .tab-active-alpha { background-color: var(--color-alpha-light); color: #854D0E; border-color: var(--color-alpha); }
        .tab-active-bravo { background-color: var(--color-bravo-light); color: #1E40AF; border-color: var(--color-bravo); }

    </style>
</head>

<body>

    <div class="max-w-[1200px] mx-auto flex flex-col min-h-screen relative border-x-0 md:border-x border-gray-200 bg-gray-50">

        <div class="md:hidden px-4 pt-4 pb-2 flex-shrink-0 z-10 sticky top-0 bg-gray-50/90 backdrop-blur">
            <div class="flex gap-3">
                <button id="tab-btn-alpha" class="w-1/2 p-2 shadow-sm" onclick="switchMobileTab('alpha')">ALPHA</button>
                <button id="tab-btn-bravo" class="w-1/2 p-2 shadow-sm" onclick="switchMobileTab('bravo')">BRAVO</button>
            </div>
        </div>

        <main class="flex-1 p-4 md:p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">

                <div id="alpha-card" class="team-card md:block">
                    <div class="team-card-header-bar bar-alpha"></div>
                    <div class="team-card-body">
                        <div class="header-section">
                            <h3 id="alpha-univ" class="univ-name">-</h3>
                            <p id="alpha-name-kana" class="team-kana"></p>
                            <h2 id="alpha-name" class="team-name">未選択</h2>

                            <div class="flex flex-wrap items-center gap-4 mt-2">
                                <div id="alpha-circle-container" class="circle-tag" onclick="">
                                    <span class="material-symbols-rounded circle-icon">diversity_3</span>
                                    <span id="alpha-circle" class="font-bold text-lg leading-none text-gray-700">-</span>
                                </div>
                                <div id="alpha-avg-xp" class="avg-xp-box hidden">XP -</div>
                            </div>
                        </div>

                        <div id="alpha-members" class="member-grid">
                            </div>
                        
                        <span id="alpha-xp-warning" class="xp-warning-text hidden">※個人XPは配信紹介禁止</span>

                        <div class="info-separator">
                            <div class="info-separator-line"></div>
                            <div class="info-separator-text">TEAM INFO</div>
                            <div class="info-separator-line"></div>
                        </div>

                        <div id="alpha-info-container">
                            </div>
                    </div>
                </div>

                <div id="bravo-card" class="team-card hidden md:block">
                    <div class="team-card-header-bar bar-bravo"></div>
                    <div class="team-card-body">
                        <div class="header-section">
                            <h3 id="bravo-univ" class="univ-name">-</h3>
                            <p id="bravo-name-kana" class="team-kana"></p>
                            <h2 id="bravo-name" class="team-name">未選択</h2>

                            <div class="flex flex-wrap items-center gap-4 mt-2">
                                <div id="bravo-circle-container" class="circle-tag" onclick="">
                                    <span class="material-symbols-rounded circle-icon">diversity_3</span>
                                    <span id="bravo-circle" class="font-bold text-lg leading-none text-gray-700">-</span>
                                </div>
                                <div id="bravo-avg-xp" class="avg-xp-box hidden">XP -</div>
                            </div>
                        </div>

                        <div id="bravo-members" class="member-grid">
                            </div>
                        
                        <span id="bravo-xp-warning" class="xp-warning-text hidden">※個人XPは配信紹介禁止</span>

                        <div class="info-separator">
                            <div class="info-separator-line"></div>
                            <div class="info-separator-text">TEAM INFO</div>
                            <div class="info-separator-line"></div>
                        </div>

                        <div id="bravo-info-container">
                            </div>
                    </div>
                </div>

            </div>
        </main>

        <button id="sync-match-btn" title="対戦設定と同期">
            <span class="material-symbols-rounded">sync_alt</span>
            <span>進行中の試合に戻る</span>
        </button>

        <footer class="footer-select-area">
            <div class="grid grid-cols-2 gap-6 w-full max-w-[800px] mx-auto">
                <div class="flex flex-col gap-1">
                    <label for="alpha-select" class="text-xs font-bold text-gray-400 ml-1 tracking-wider">ALPHA TEAM</label>
                    <select id="alpha-select" class="team-select" style="border-left: 6px solid var(--color-alpha);">
                        <option value="">選択してください</option>
                    </select>
                </div>
                <div class="flex flex-col gap-1">
                    <label for="bravo-select" class="text-xs font-bold text-gray-400 ml-1 tracking-wider">BRAVO TEAM</label>
                    <select id="bravo-select" class="team-select" style="border-left: 6px solid var(--color-bravo);">
                        <option value="">選択してください</option>
                    </select>
                </div>
            </div>
        </footer>

    </div>

    <div id="circle-modal" class="modal-overlay">
        <div class="modal-content bg-white">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-xl text-gray-700 flex items-center gap-2">
                    <span class="material-symbols-rounded">diversity_3</span> CIRCLE INFO
                </h3>
                <button onclick="closeCircleModal()" class="p-2 hover:bg-gray-200 rounded-full text-gray-500 transition-all"><span
                        class="material-symbols-rounded">close</span></button>
            </div>
            <div class="p-8 overflow-y-auto">
                <div class="flex flex-col items-center text-center mb-8">
                    <div class="w-32 h-32 rounded-full overflow-hidden border-2 border-gray-200 shadow-md mb-4 bg-gray-100">
                        <img id="modal-circle-img" src="" alt="icon" class="w-full h-full object-cover"
                            onerror="this.src='data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'%23e5e7eb\' viewBox=\'0 0 24 24\'%3e%3cpath d=\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z\'/%3e%3c/svg%3e'">
                    </div>
                    <p id="modal-circle-univ" class="text-md font-bold text-gray-500 mb-1 uppercase tracking-widest">
                        UNIVERSITY</p>
                    <h2 id="modal-circle-name" class="text-3xl font-black text-gray-800 mb-6">サークル名</h2>
                    <div class="flex flex-wrap justify-center gap-4 mb-4">
                        <span id="modal-circle-id"
                            class="inline-flex items-center px-3 py-1 bg-white border border-gray-300 shadow-sm font-bold text-gray-600 rounded-lg text-sm"></span>
                        <span id="modal-circle-win"
                            class="inline-flex items-center px-3 py-1 bg-white border border-gray-300 shadow-sm font-bold text-gray-600 rounded-lg text-sm"></span>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                    <p id="modal-circle-comment" class="text-gray-700 leading-relaxed whitespace-pre-wrap font-medium"></p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.firebasestorage.app",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const matchRef = doc(db, "state", "match");

        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // Mobile Tab Logic
            window.switchMobileTab = function (side) {
                const alphaCard = document.getElementById('alpha-card');
                const bravoCard = document.getElementById('bravo-card');
                const btnAlpha = document.getElementById('tab-btn-alpha');
                const btnBravo = document.getElementById('tab-btn-bravo');

                if (side === 'alpha') {
                    alphaCard.classList.remove('hidden'); bravoCard.classList.add('hidden');
                    btnAlpha.classList.add('tab-active-alpha');
                    btnBravo.classList.remove('tab-active-bravo');
                } else {
                    alphaCard.classList.add('hidden'); bravoCard.classList.remove('hidden');
                    btnAlpha.classList.remove('tab-active-alpha');
                    btnBravo.classList.add('tab-active-bravo');
                }
            };

            // Circle Modal
            const circleModal = document.getElementById('circle-modal');
            const modalImg = document.getElementById('modal-circle-img');
            const modalUniv = document.getElementById('modal-circle-univ');
            const modalName = document.getElementById('modal-circle-name');
            const modalId = document.getElementById('modal-circle-id');
            const modalWin = document.getElementById('modal-circle-win');
            const modalComment = document.getElementById('modal-circle-comment');

            window.openCircleModal = (circleName) => {
                const info = circleData.find(c => c['circleName'] === circleName) || circleData.find(c => c['circle_name'] === circleName);
                if (!info) return;
                
                modalImg.src = info['icon_url'] || ''; 
                modalUniv.textContent = info['university'] || '';
                modalName.textContent = info['circleName'] || '';
                modalId.textContent = info['twitter'] || '';
                modalWin.textContent = info['hashtag'] ? `#${info['hashtag'].replace('#','')}` : '';
                modalComment.innerHTML = info['description'] || '';
                circleModal.classList.add('show');
            };
            window.closeCircleModal = () => circleModal.classList.remove('show');
            circleModal.addEventListener('click', (e) => { if (e.target === circleModal) closeCircleModal(); });

            // Elements
            const alphaSelect = document.getElementById('alpha-select');
            const bravoSelect = document.getElementById('bravo-select');
            const syncMatchBtn = document.getElementById('sync-match-btn');

            const els = {
                alpha: {
                    container: document.getElementById('alpha-card'),
                    name: document.getElementById('alpha-name'),
                    kana: document.getElementById('alpha-name-kana'), 
                    avgXp: document.getElementById('alpha-avg-xp'),
                    univ: document.getElementById('alpha-univ'), 
                    circle: document.getElementById('alpha-circle'),
                    circleContainer: document.getElementById('alpha-circle-container'),
                    infoContainer: document.getElementById('alpha-info-container'),
                    members: document.getElementById('alpha-members'),
                    warning: document.getElementById('alpha-xp-warning')
                },
                bravo: {
                    container: document.getElementById('bravo-card'),
                    name: document.getElementById('bravo-name'),
                    kana: document.getElementById('bravo-name-kana'), 
                    avgXp: document.getElementById('bravo-avg-xp'),
                    univ: document.getElementById('bravo-univ'), 
                    circle: document.getElementById('bravo-circle'),
                    circleContainer: document.getElementById('bravo-circle-container'),
                    infoContainer: document.getElementById('bravo-info-container'),
                    members: document.getElementById('bravo-members'),
                    warning: document.getElementById('bravo-xp-warning')
                }
            };

            let teamsData = [];
            let circleData = [];
            // Firebaseから取得したアクティブな試合状態
            let activeMatchState = { alphaId: "", bravoId: "" };

            async function loadData() {
                try {
                    const [teamsRes, circleRes] = await Promise.all([
                        fetch('../json/teams.json'),
                        fetch('../json/circle-info.json')
                    ]);

                    if (teamsRes.ok) teamsData = await teamsRes.json();
                    if (circleRes.ok) circleData = await circleRes.json();

                    initSelects();
                    restoreLocalState();
                    
                    // データのロードが完了してから監視を開始
                    startFirestoreListener();
                } catch (error) {
                    console.error('Failed to load data:', error);
                }
            }

            function initSelects() {
                const fragA = document.createDocumentFragment();
                const fragB = document.createDocumentFragment();
                teamsData.forEach(team => {
                    const optA = document.createElement('option');
                    optA.value = team.id; optA.textContent = team.teamName; fragA.appendChild(optA);
                    const optB = document.createElement('option');
                    optB.value = team.id; optB.textContent = team.teamName; fragB.appendChild(optB);
                });
                alphaSelect.appendChild(fragA);
                bravoSelect.appendChild(fragB);

                alphaSelect.addEventListener('change', (e) => { updateTeamView('alpha', e.target.value); saveLocalState('alpha', e.target.value); checkSyncState(); });
                bravoSelect.addEventListener('change', (e) => { updateTeamView('bravo', e.target.value); saveLocalState('bravo', e.target.value); checkSyncState(); });
            }

            function updateTeamView(side, teamId) {
                const el = els[side];
                const team = teamsData.find(t => t.id === teamId);
                const isValid = (txt) => txt && txt !== "----" && txt !== "";

                if (!team) {
                    el.name.textContent = "未選択"; el.kana.textContent = ""; el.univ.textContent = "-";
                    el.circle.textContent = "-"; el.avgXp.classList.add('hidden');
                    el.warning.classList.add('hidden');
                    el.infoContainer.innerHTML = "";
                    el.members.innerHTML = `<div class="p-8 text-center text-gray-400 font-bold border-2 border-dashed border-gray-200 rounded-xl text-lg">チームを選択してください</div>`;
                    return;
                }

                el.name.textContent = team.teamName;
                el.kana.textContent = isValid(team.teamName_kana) ? team.teamName_kana : "";
                el.univ.textContent = team.university;
                el.circle.textContent = team.circle;
                el.circleContainer.onclick = () => openCircleModal(team.circle);

                if (isValid(team.team_average_xp)) {
                    el.avgXp.textContent = `XP ${Math.floor(Number(team.team_average_xp))}`;
                    el.avgXp.classList.remove('hidden');
                } else { el.avgXp.classList.add('hidden'); }

                // Members
                let maxXp = 0;
                for (let i = 1; i <= 4; i++) {
                    const px = team[`p${i}_xp`];
                    if (isValid(px)) { const val = Number(px); if (!isNaN(val) && val > maxXp) maxXp = val; }
                }

                el.members.innerHTML = '';
                for (let i = 1; i <= 4; i++) {
                    const pName = team[`p${i}_name`];
                    if (!isValid(pName)) continue;
                    const pKana = team[`p${i}_name_kana`];
                    const pXp = team[`p${i}_xp`];
                    const pWeapon = team[`p${i}_weapon`];
                    const xpVal = isValid(pXp) ? Math.floor(Number(pXp)) : " - ";
                    const isHighest = (isValid(pXp) && Number(pXp) === maxXp && maxXp > 0);
                    
                    const row = document.createElement('div');
                    row.className = `member-card ${isHighest ? (side==='alpha'?'highest-xp-alpha':'highest-xp-bravo') : ''}`;
                    
                    const kanaHtml = isValid(pKana) ? `<span class="member-kana">${pKana}</span>` : "";

                    row.innerHTML = `
                        <div class="xp-box">${xpVal}</div>
                        <div class="name-group">
                            <span class="member-name">${pName}</span>
                            ${kanaHtml}
                            <span class="member-weapon">${pWeapon || '-'}</span>
                        </div>
                    `;
                    el.members.appendChild(row);
                }

                // Show Warning
                el.warning.classList.remove('hidden');

                // Info Sections
                let infoHtml = '';
                const appendInfo = (label, text, isDanger=false) => {
                    const cls = isDanger ? "tactics" : "";
                    infoHtml += `<div class="info-block ${cls}"><div class="info-label">${label}</div><p class="info-content">${text}</p></div>`;
                };
                if (isValid(team.comment)) appendInfo("意気込み", team.comment);
                if (isValid(team.records)) appendInfo("実績", team.records);
                if (isValid(team.message)) appendInfo("メッセージ", team.message);
                if (isValid(team.tactics)) appendInfo("戦略 (配信紹介禁止)", team.tactics, true);
                el.infoContainer.innerHTML = infoHtml;
            }

            // Sync Logic with Firestore
            function startFirestoreListener() {
                onSnapshot(matchRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        activeMatchState.alphaId = data.alphaTeamId;
                        activeMatchState.bravoId = data.bravoTeamId;
                        checkSyncState();
                    }
                });
            }

            // 既存のBroadcastChannelは念のため残すが、基本はFirestoreが優先
            const BROADCAST_CHANNEL = new BroadcastChannel('university_spl_match_control');
            BROADCAST_CHANNEL.onmessage = (event) => {
                const { alphaId, bravoId } = event.data;
                if (alphaId && bravoId) { 
                    activeMatchState = { alphaId, bravoId }; 
                    checkSyncState(); 
                }
            };

            function checkSyncState() {
                // 進行中の試合IDが存在し、かつ現在選択中のIDと異なる場合にボタンを表示
                const isDifferent = (
                    activeMatchState.alphaId && alphaSelect.value !== activeMatchState.alphaId
                ) || (
                    activeMatchState.bravoId && bravoSelect.value !== activeMatchState.bravoId
                );

                if (isDifferent) {
                    syncMatchBtn.classList.add('show');
                } else {
                    syncMatchBtn.classList.remove('show');
                }
            }

            syncMatchBtn.addEventListener('click', () => {
                if (activeMatchState.alphaId) { 
                    alphaSelect.value = activeMatchState.alphaId; 
                    updateTeamView('alpha', activeMatchState.alphaId); 
                    saveLocalState('alpha', activeMatchState.alphaId); 
                }
                if (activeMatchState.bravoId) { 
                    bravoSelect.value = activeMatchState.bravoId; 
                    updateTeamView('bravo', activeMatchState.bravoId); 
                    saveLocalState('bravo', activeMatchState.bravoId); 
                }
                checkSyncState();
            });

            function saveLocalState(side, id) { localStorage.setItem(`team_viewer_${side}`, id); }
            function restoreLocalState() {
                const a = localStorage.getItem('team_viewer_alpha'), b = localStorage.getItem('team_viewer_bravo');
                if (a) { alphaSelect.value = a; updateTeamView('alpha', a); }
                if (b) { bravoSelect.value = b; updateTeamView('bravo', b); }
            }
            loadData();
        });
    </script>
</body>
</html>